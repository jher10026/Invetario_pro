<!-- ===================================
     TEMPLATE CON FORMULARIO REACTIVO
     Archivo: src/app/components/inventario/inventario.html
     
     ‚úÖ CAMBIOS PARA REACTIVE FORMS
     =================================== -->

<div class="inventario-container">
  <!-- Header -->
  <div class="content-header">
    <h1>Inventario</h1>
    <div class="user-avatar" (click)="abrirModalAvatar()" title="Cambiar foto de perfil">
      @if (usuarioActual?.photoURL) {
      <img [src]="usuarioActual!.photoURL" alt="Foto de perfil" class="avatar-image" />
      } @else {
      {{ iniciales }}
      }
    </div>
  </div>

  <!-- Tabla de productos -->
  <div class="table-container">
    <div class="table-header">
      <h2>üìã Lista de Productos</h2>
      <button *ngIf="usuarioActual?.role === 'admin'" class="btn btn-primary" (click)="abrirModalNuevo()"
        [disabled]="guardando()">
        ‚ûï Nuevo
      </button>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <input type="text" class="search-input" [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)"
        placeholder="üîç Buscar producto..." />

      <select class="select-input" [ngModel]="categoriaSeleccionada()"
        (ngModelChange)="categoriaSeleccionada.set($event)">
        <option value="">Todas las Categor√≠as</option>
        <option *ngFor="let cat of categorias()" [value]="cat.nombre">
          {{ cat.nombre }}
        </option>
      </select>

      <select class="select-input" [ngModel]="estadoSeleccionado()" (ngModelChange)="estadoSeleccionado.set($event)">
        <option value="">Todos los Estados</option>
        <option value="disponible">En Stock</option>
        <option value="bajo">Stock Bajo</option>
        <option value="agotado">Agotado</option>
      </select>

      <select class="select-input" [ngModel]="ordenamiento()" (ngModelChange)="ordenamiento.set($event)">
        <option value="recent">M√°s Recientes</option>
        <option value="oldest">M√°s Antiguos</option>
        <option value="name">Por Nombre</option>
        <option value="price">Por Precio</option>
      </select>
    </div>

    <!-- Estado de carga -->
    <div *ngIf="cargando()" class="loading-state">
      <span class="spinner"></span>
      Cargando productos...
    </div>

    <!-- Tabla -->
    <div class="table-wrapper" *ngIf="!cargando()">
      <table>
        <thead>
          <tr>
            <th>Producto / Fecha</th>
            <th>Categor√≠a</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="productosFiltrados().length === 0">
            <td colspan="5" class="empty-state">
              No se encontraron productos
            </td>
          </tr>

          <tr *ngFor="let producto of productosFiltrados()" class="product-row">
            <td>
              <span class="product-name">{{ producto.nombre }}</span>
              <span class="product-date">
                Ingreso: {{ producto.fecha | date: 'dd/MM/yyyy' }}
              </span>
            </td>
            <td>
              <span class="badge"
                [style]="'background: ' + obtenerColorCategoria(producto.categoria) + '20; color: ' + obtenerColorCategoria(producto.categoria) + '; border: 1px solid ' + obtenerColorCategoria(producto.categoria) + '40;'">
                {{ producto.categoria }}
              </span>
            </td>
            <td>S/ {{ producto.precio.toFixed(2) }}</td>
            <td>
              <span [ngClass]="['status', obtenerEstado(producto.stock)]">
                {{ obtenerTextoEstado(producto.stock) }}
              </span>
            </td>
            <td class="actions">
              <button *ngIf="usuarioActual?.role === 'admin'" class="btn-icon edit" (click)="abrirModalEditar(producto)"
                [disabled]="guardando()" title="Editar">
                ‚úèÔ∏è
              </button>
              <button *ngIf="usuarioActual?.role === 'admin'" class="btn-icon delete"
                (click)="eliminarProducto(producto.id, producto.nombre)" [disabled]="guardando()" title="Eliminar">
                üóëÔ∏è
              </button>
              <span *ngIf="usuarioActual?.role !== 'admin'" class="solo-lectura">
                üëÅÔ∏è Solo lectura
              </span>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="table-footer" *ngIf="!cargando()">
      Mostrando {{ productosFiltrados().length }} productos
    </div>
  </div>
</div>

<!-- ‚úÖ MODAL CON FORMULARIO REACTIVO -->
<div *ngIf="mostrarModal()" class="modal-overlay" (click)="cerrarModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ editandoProducto() ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
      <button class="close-btn" (click)="cerrarModal()">√ó</button>
    </div>

    <!-- ‚úÖ FORMULARIO REACTIVO -->
    <form [formGroup]="productoForm" (ngSubmit)="guardarProducto()">
      <div class="modal-body">
        <!-- Nombre -->
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" class="form-input" formControlName="nombre" placeholder="Ej: Laptop Dell XPS"
            [class.error]="hasError('nombre', 'required') || hasError('nombre', 'minlength')" />
          <span class="error-message" *ngIf="hasError('nombre', 'required')">
            ‚ö†Ô∏è El nombre es requerido
          </span>
          <span class="error-message" *ngIf="hasError('nombre', 'minlength')">
            ‚ö†Ô∏è M√≠nimo 3 caracteres
          </span>
        </div>

        <!-- Fecha -->
        <div class="form-group">
          <label>Fecha de Ingreso *</label>
          <input type="date" class="form-input" formControlName="fecha" [class.error]="hasError('fecha', 'required')" />
          <span class="error-message" *ngIf="hasError('fecha', 'required')">
            ‚ö†Ô∏è La fecha es requerida
          </span>
        </div>

        <!-- Categor√≠a -->
        <div class="form-group">
          <label>Categor√≠a *</label>
          <select class="form-input" formControlName="categoria" [class.error]="hasError('categoria', 'required')">
            <option value="">Seleccionar categor√≠a</option>
            <option *ngFor="let cat of categorias()" [value]="cat.nombre">
              {{ cat.nombre }}
            </option>
          </select>
          <span class="error-message" *ngIf="hasError('categoria', 'required')">
            ‚ö†Ô∏è Debes seleccionar una categor√≠a
          </span>
        </div>

        <!-- Precio y Stock -->
        <div class="form-row">
          <div class="form-group">
            <label>Precio (S/) *</label>
            <input type="number" class="form-input" formControlName="precio" step="0.01" min="0" placeholder="0.00"
              [class.error]="hasError('precio', 'required') || hasError('precio', 'min')" />
            <span class="error-message" *ngIf="hasError('precio', 'required')">
              ‚ö†Ô∏è El precio es requerido
            </span>
            <span class="error-message" *ngIf="hasError('precio', 'min')">
              ‚ö†Ô∏è El precio debe ser mayor a 0
            </span>
          </div>

          <div class="form-group">
            <label>Stock *</label>
            <input type="number" class="form-input" formControlName="stock" min="0" placeholder="0"
              [class.error]="hasError('stock', 'required') || hasError('stock', 'min')" />
            <span class="error-message" *ngIf="hasError('stock', 'required')">
              ‚ö†Ô∏è El stock es requerido
            </span>
            <span class="error-message" *ngIf="hasError('stock', 'min')">
              ‚ö†Ô∏è El stock no puede ser negativo
            </span>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" (click)="cerrarModal()" [disabled]="guardando()">
          Cancelar
        </button>
        <button type="submit" class="btn-save" [disabled]="guardando() || productoForm.invalid">
          @if (guardando()) {
          <span class="spinner"></span> Guardando...
          } @else {
          Guardar
          }
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL DE CONFIRMACI√ìN ELIMINAR -->
<div *ngIf="mostrarModalEliminar()" class="modal-overlay" (click)="cancelarEliminacion()">
  <div class="modal-confirm" (click)="$event.stopPropagation()">
    <div class="modal-confirm-icon">
      <span class="icon-warning">‚ö†Ô∏è</span>
    </div>

    <div class="modal-confirm-content">
      <h2>¬øEliminar Producto?</h2>
      <p>
        ¬øEst√°s seguro que deseas eliminar
        <strong>"{{ productoAEliminar()?.nombre }}"</strong>?
      </p>
      <p class="warning-text">Esta acci√≥n no se puede deshacer.</p>
    </div>

    <div class="modal-confirm-actions">
      <button class="btn-cancel-confirm" (click)="cancelarEliminacion()" [disabled]="guardando()">
        Cancelar
      </button>
      <button class="btn-delete-confirm" (click)="confirmarEliminacion()" [disabled]="guardando()">
        @if (guardando()) {
        <span class="spinner"></span> Eliminando...
        } @else {
        üóëÔ∏è Eliminar
        }
      </button>
    </div>
  </div>
</div>

<style>
  /* Estilos para errores de validaci√≥n */
  .form-input.error {
    border-color: #ef4444 !important;
    background-color: #fef2f2;
  }

  .error-message {
    display: block;
    color: #ef4444;
    font-size: 0.875rem;
    margin-top: 0.25rem;
    font-weight: 500;
  }

  .btn-save:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<!-- Modal de Avatar -->
<app-avatar-modal [visible]="mostrarModalAvatar()" [currentPhotoURL]="usuarioActual?.photoURL" [iniciales]="iniciales"
  (cerrar)="cerrarModalAvatar()" (fotoActualizada)="onFotoActualizada($event)"></app-avatar-modal>